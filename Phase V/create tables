-- ============================================
-- AUCA CAPSTONE PROJECT - PHILIMIN HABANABASHAKA
-- ID: 27487 | GROUP: A
-- EQUIPMENT MAINTENANCE MANAGEMENT SYSTEM
-- ============================================

-- First, check what already exists
SET SERVEROUTPUT ON
BEGIN
    DBMS_OUTPUT.PUT_LINE('Checking existing objects...');
END;
/

-- Check existing sequences
SELECT sequence_name, last_number FROM user_sequences ORDER BY sequence_name;

-- Check existing tables
SELECT table_name, num_rows FROM user_tables ORDER BY table_name;

-- ============================================
-- OPTION 1: DROP EVERYTHING AND START FRESH
-- ============================================
/*
-- Drop tables in correct order (due to foreign keys)
DROP TABLE AUDIT_LOG CASCADE CONSTRAINTS;
DROP TABLE HOLIDAYS CASCADE CONSTRAINTS;
DROP TABLE ALERTS CASCADE CONSTRAINTS;
DROP TABLE MAINTENANCE CASCADE CONSTRAINTS;
DROP TABLE USERS CASCADE CONSTRAINTS;
DROP TABLE EQUIPMENT CASCADE CONSTRAINTS;
DROP TABLE TECHNICIANS CASCADE CONSTRAINTS;
DROP TABLE DEPARTMENTS CASCADE CONSTRAINTS;

-- Drop sequences
DROP SEQUENCE seq_dept_id;
DROP SEQUENCE seq_equipment_id;
DROP SEQUENCE seq_tech_id;
DROP SEQUENCE seq_maintenance_id;
DROP SEQUENCE seq_alert_id;
DROP SEQUENCE seq_user_id;
DROP SEQUENCE seq_holiday_id;
DROP SEQUENCE seq_audit_log_id;
*/

-- ============================================
-- OPTION 2: CONDITIONAL CREATION (BETTER APPROACH)
-- ============================================

-- 1. Create sequences (only if they don't exist)
BEGIN
    EXECUTE IMMEDIATE 'CREATE SEQUENCE seq_dept_id START WITH 1 INCREMENT BY 1';
    DBMS_OUTPUT.PUT_LINE('Sequence seq_dept_id created.');
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE = -955 THEN -- already exists
            DBMS_OUTPUT.PUT_LINE('Sequence seq_dept_id already exists.');
        ELSE
            RAISE;
        END IF;
END;
/

BEGIN
    EXECUTE IMMEDIATE 'CREATE SEQUENCE seq_equipment_id START WITH 100 INCREMENT BY 1';
    DBMS_OUTPUT.PUT_LINE('Sequence seq_equipment_id created.');
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE = -955 THEN
            DBMS_OUTPUT.PUT_LINE('Sequence seq_equipment_id already exists.');
        ELSE
            RAISE;
        END IF;
END;
/

BEGIN
    EXECUTE IMMEDIATE 'CREATE SEQUENCE seq_tech_id START WITH 200 INCREMENT BY 1';
    DBMS_OUTPUT.PUT_LINE('Sequence seq_tech_id created.');
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE = -955 THEN
            DBMS_OUTPUT.PUT_LINE('Sequence seq_tech_id already exists.');
        ELSE
            RAISE;
        END IF;
END;
/

BEGIN
    EXECUTE IMMEDIATE 'CREATE SEQUENCE seq_maintenance_id START WITH 300 INCREMENT BY 1';
    DBMS_OUTPUT.PUT_LINE('Sequence seq_maintenance_id created.');
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE = -955 THEN
            DBMS_OUTPUT.PUT_LINE('Sequence seq_maintenance_id already exists.');
        ELSE
            RAISE;
        END IF;
END;
/

BEGIN
    EXECUTE IMMEDIATE 'CREATE SEQUENCE seq_alert_id START WITH 400 INCREMENT BY 1';
    DBMS_OUTPUT.PUT_LINE('Sequence seq_alert_id created.');
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE = -955 THEN
            DBMS_OUTPUT.PUT_LINE('Sequence seq_alert_id already exists.');
        ELSE
            RAISE;
        END IF;
END;
/

BEGIN
    EXECUTE IMMEDIATE 'CREATE SEQUENCE seq_user_id START WITH 500 INCREMENT BY 1';
    DBMS_OUTPUT.PUT_LINE('Sequence seq_user_id created.');
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE = -955 THEN
            DBMS_OUTPUT.PUT_LINE('Sequence seq_user_id already exists.');
        ELSE
            RAISE;
        END IF;
END;
/

BEGIN
    EXECUTE IMMEDIATE 'CREATE SEQUENCE seq_holiday_id START WITH 600 INCREMENT BY 1';
    DBMS_OUTPUT.PUT_LINE('Sequence seq_holiday_id created.');
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE = -955 THEN
            DBMS_OUTPUT.PUT_LINE('Sequence seq_holiday_id already exists.');
        ELSE
            RAISE;
        END IF;
END;
/

BEGIN
    EXECUTE IMMEDIATE 'CREATE SEQUENCE seq_audit_log_id START WITH 700 INCREMENT BY 1';
    DBMS_OUTPUT.PUT_LINE('Sequence seq_audit_log_id created.');
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE = -955 THEN
            DBMS_OUTPUT.PUT_LINE('Sequence seq_audit_log_id already exists.');
        ELSE
            RAISE;
        END IF;
END;
/

-- 2. Create tables (only if they don't exist)
-- First check if DEPARTMENTS table exists with correct structure
DECLARE
    v_table_exists NUMBER;
    v_column_count NUMBER;
BEGIN
    -- Check if table exists
    SELECT COUNT(*) INTO v_table_exists
    FROM user_tables
    WHERE table_name = 'DEPARTMENTS';
    
    IF v_table_exists = 0 THEN
        -- Create DEPARTMENTS table
        EXECUTE IMMEDIATE '
        CREATE TABLE DEPARTMENTS (
            DEPT_ID NUMBER(10) PRIMARY KEY,
            DEPT_NAME VARCHAR2(100) NOT NULL,
            LOCATION VARCHAR2(200) NOT NULL,
            HEAD_OF_DEPT VARCHAR2(100),
            CREATED_DATE DATE DEFAULT SYSDATE,
            MODIFIED_DATE DATE
        )';
        DBMS_OUTPUT.PUT_LINE('Table DEPARTMENTS created.');
    ELSE
        -- Check structure
        SELECT COUNT(*) INTO v_column_count
        FROM user_tab_columns
        WHERE table_name = 'DEPARTMENTS';
        
        IF v_column_count >= 6 THEN
            DBMS_OUTPUT.PUT_LINE('Table DEPARTMENTS already exists with ' || v_column_count || ' columns.');
        ELSE
            -- Table exists but with wrong structure - drop and recreate
            EXECUTE IMMEDIATE 'DROP TABLE DEPARTMENTS CASCADE CONSTRAINTS';
            EXECUTE IMMEDIATE '
            CREATE TABLE DEPARTMENTS (
                DEPT_ID NUMBER(10) PRIMARY KEY,
                DEPT_NAME VARCHAR2(100) NOT NULL,
                LOCATION VARCHAR2(200) NOT NULL,
                HEAD_OF_DEPT VARCHAR2(100),
                CREATED_DATE DATE DEFAULT SYSDATE,
                MODIFIED_DATE DATE
            )';
            DBMS_OUTPUT.PUT_LINE('Table DEPARTMENTS recreated.');
        END IF;
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Error with DEPARTMENTS: ' || SQLERRM);
END;
/

-- Create EQUIPMENT table
BEGIN
    EXECUTE IMMEDIATE '
    CREATE TABLE EQUIPMENT (
        EQUIPMENT_ID NUMBER(10) PRIMARY KEY,
        NAME VARCHAR2(200) NOT NULL,
        CATEGORY VARCHAR2(50),
        PURCHASE_DATE DATE NOT NULL,
        WARRANTY_EXPIRY DATE,
        STATUS VARCHAR2(20) DEFAULT ''Active'' 
            CHECK (STATUS IN (''Active'',''Inactive'',''Under Maintenance'',''Retired'')),
        DEPT_ID NUMBER(10),
        SERIAL_NUMBER VARCHAR2(50) UNIQUE,
        MANUFACTURER VARCHAR2(100),
        MODEL VARCHAR2(50),
        LAST_MAINTENANCE_DATE DATE,
        NEXT_MAINTENANCE_DATE DATE,
        TOTAL_MAINTENANCE_COST NUMBER(10,2) DEFAULT 0,
        CREATED_DATE DATE DEFAULT SYSDATE,
        MODIFIED_DATE DATE,
        CONSTRAINT fk_equipment_dept FOREIGN KEY (DEPT_ID) 
            REFERENCES DEPARTMENTS(DEPT_ID) ON DELETE SET NULL
    )';
    DBMS_OUTPUT.PUT_LINE('Table EQUIPMENT created.');
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE = -955 THEN
            DBMS_OUTPUT.PUT_LINE('Table EQUIPMENT already exists.');
        ELSE
            DBMS_OUTPUT.PUT_LINE('Error creating EQUIPMENT: ' || SQLERRM);
        END IF;
END;
/

-- Create TECHNICIANS table
BEGIN
    EXECUTE IMMEDIATE '
    CREATE TABLE TECHNICIANS (
        TECH_ID NUMBER(10) PRIMARY KEY,
        FULL_NAME VARCHAR2(100) NOT NULL,
        CONTACT VARCHAR2(50),
        SPECIALTY VARCHAR2(100),
        EMAIL VARCHAR2(100) UNIQUE,
        HIRE_DATE DATE DEFAULT SYSDATE,
        STATUS VARCHAR2(20) DEFAULT ''Active'' 
            CHECK (STATUS IN (''Active'',''Inactive'',''On Leave'')),
        HOURLY_RATE NUMBER(8,2) DEFAULT 25.00,
        TOTAL_ASSIGNMENTS NUMBER(5) DEFAULT 0
    )';
    DBMS_OUTPUT.PUT_LINE('Table TECHNICIANS created.');
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE = -955 THEN
            DBMS_OUTPUT.PUT_LINE('Table TECHNICIANS already exists.');
        ELSE
            DBMS_OUTPUT.PUT_LINE('Error creating TECHNICIANS: ' || SQLERRM);
        END IF;
END;
/

-- Create MAINTENANCE table
BEGIN
    EXECUTE IMMEDIATE '
    CREATE TABLE MAINTENANCE (
        MAINTENANCE_ID NUMBER(10) PRIMARY KEY,
        EQUIPMENT_ID NUMBER(10) NOT NULL,
        TECH_ID NUMBER(10) NOT NULL,
        MAINTENANCE_DATE DATE DEFAULT SYSDATE,
        COMPLETION_DATE DATE,
        COST NUMBER(10,2) DEFAULT 0,
        DESCRIPTION VARCHAR2(500),
        TYPE VARCHAR2(20) DEFAULT ''Corrective'' 
            CHECK (TYPE IN (''Preventive'',''Corrective'',''Emergency'',''Upgrade'')),
        STATUS VARCHAR2(20) DEFAULT ''Scheduled'' 
            CHECK (STATUS IN (''Scheduled'',''In Progress'',''Completed'',''Cancelled'')),
        PARTS_USED VARCHAR2(500),
        LABOR_HOURS NUMBER(5,2),
        CONSTRAINT fk_maintenance_equipment FOREIGN KEY (EQUIPMENT_ID) 
            REFERENCES EQUIPMENT(EQUIPMENT_ID) ON DELETE CASCADE,
        CONSTRAINT fk_maintenance_tech FOREIGN KEY (TECH_ID) 
            REFERENCES TECHNICIANS(TECH_ID) ON DELETE CASCADE
    )';
    DBMS_OUTPUT.PUT_LINE('Table MAINTENANCE created.');
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE = -955 THEN
            DBMS_OUTPUT.PUT_LINE('Table MAINTENANCE already exists.');
        ELSE
            DBMS_OUTPUT.PUT_LINE('Error creating MAINTENANCE: ' || SQLERRM);
        END IF;
END;
/

-- Create ALERTS table
BEGIN
    EXECUTE IMMEDIATE '
    CREATE TABLE ALERTS (
        ALERT_ID NUMBER(10) PRIMARY KEY,
        EQUIPMENT_ID NUMBER(10) NOT NULL,
        ISSUE_DESCRIPTION VARCHAR2(500) NOT NULL,
        DATE_REPORTED DATE DEFAULT SYSDATE,
        DATE_ASSIGNED DATE,
        DATE_RESOLVED DATE,
        STATUS VARCHAR2(20) DEFAULT ''Open'' 
            CHECK (STATUS IN (''Open'',''Assigned'',''In Progress'',''Resolved'',''Closed'')),
        PRIORITY VARCHAR2(10) DEFAULT ''Medium'' 
            CHECK (PRIORITY IN (''Low'',''Medium'',''High'',''Critical'')),
        REPORTED_BY VARCHAR2(100),
        ASSIGNED_TO NUMBER(10),
        CONSTRAINT fk_alerts_equipment FOREIGN KEY (EQUIPMENT_ID) 
            REFERENCES EQUIPMENT(EQUIPMENT_ID) ON DELETE CASCADE,
        CONSTRAINT fk_alerts_tech FOREIGN KEY (ASSIGNED_TO) 
            REFERENCES TECHNICIANS(TECH_ID) ON DELETE SET NULL
    )';
    DBMS_OUTPUT.PUT_LINE('Table ALERTS created.');
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE = -955 THEN
            DBMS_OUTPUT.PUT_LINE('Table ALERTS already exists.');
        ELSE
            DBMS_OUTPUT.PUT_LINE('Error creating ALERTS: ' || SQLERRM);
        END IF;
END;
/

-- Create USERS table
BEGIN
    EXECUTE IMMEDIATE '
    CREATE TABLE USERS (
        USER_ID NUMBER(10) PRIMARY KEY,
        USERNAME VARCHAR2(50) UNIQUE NOT NULL,
        PASSWORD VARCHAR2(100) NOT NULL,
        FULL_NAME VARCHAR2(100) NOT NULL,
        ROLE VARCHAR2(20) DEFAULT ''Viewer'' 
            CHECK (ROLE IN (''Admin'',''Technician'',''Department Head'',''Viewer'')),
        DEPT_ID NUMBER(10),
        EMAIL VARCHAR2(100) UNIQUE,
        LAST_LOGIN TIMESTAMP,
        CREATED_DATE DATE DEFAULT SYSDATE
    )';
    DBMS_OUTPUT.PUT_LINE('Table USERS created.');
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE = -955 THEN
            DBMS_OUTPUT.PUT_LINE('Table USERS already exists.');
        ELSE
            DBMS_OUTPUT.PUT_LINE('Error creating USERS: ' || SQLERRM);
        END IF;
END;
/

-- Create HOLIDAYS table
BEGIN
    EXECUTE IMMEDIATE '
    CREATE TABLE HOLIDAYS (
        HOLIDAY_ID NUMBER(10) PRIMARY KEY,
        HOLIDAY_NAME VARCHAR2(100) NOT NULL,
        HOLIDAY_DATE DATE NOT NULL,
        YEAR NUMBER(4) GENERATED ALWAYS AS (EXTRACT(YEAR FROM HOLIDAY_DATE)) VIRTUAL,
        IS_RECURRING CHAR(1) DEFAULT ''Y'' CHECK (IS_RECURRING IN (''Y'',''N'')),
        CREATED_DATE DATE DEFAULT SYSDATE,
        CONSTRAINT unique_holiday_date UNIQUE (HOLIDAY_DATE)
    )';
    DBMS_OUTPUT.PUT_LINE('Table HOLIDAYS created.');
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE = -955 THEN
            DBMS_OUTPUT.PUT_LINE('Table HOLIDAYS already exists.');
        ELSE
            DBMS_OUTPUT.PUT_LINE('Error creating HOLIDAYS: ' || SQLERRM);
        END IF;
END;
/

-- Create AUDIT_LOG table
BEGIN
    EXECUTE IMMEDIATE '
    CREATE TABLE AUDIT_LOG (
        LOG_ID NUMBER(10) PRIMARY KEY,
        USER_ID NUMBER(10),
        USERNAME VARCHAR2(50),
        TABLE_NAME VARCHAR2(50) NOT NULL,
        ACTION_TYPE VARCHAR2(10) NOT NULL 
            CHECK (ACTION_TYPE IN (''INSERT'',''UPDATE'',''DELETE'')),
        ACTION_DATE TIMESTAMP DEFAULT SYSTIMESTAMP,
        RECORD_ID VARCHAR2(50),
        OLD_VALUE CLOB,
        NEW_VALUE CLOB,
        STATUS VARCHAR2(20) DEFAULT ''SUCCESS'' 
            CHECK (STATUS IN (''SUCCESS'',''DENIED'')),
        ERROR_MESSAGE VARCHAR2(500),
        IP_ADDRESS VARCHAR2(50),
        SESSION_ID VARCHAR2(100)
    )';
    DBMS_OUTPUT.PUT_LINE('Table AUDIT_LOG created.');
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE = -955 THEN
            DBMS_OUTPUT.PUT_LINE('Table AUDIT_LOG already exists.');
        ELSE
            DBMS_OUTPUT.PUT_LINE('Error creating AUDIT_LOG: ' || SQLERRM);
        END IF;
END;
/

-- 3. Create indexes (only if they don't exist)
BEGIN
    EXECUTE IMMEDIATE 'CREATE INDEX idx_equipment_dept ON EQUIPMENT(DEPT_ID)';
    DBMS_OUTPUT.PUT_LINE('Index idx_equipment_dept created.');
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE = -955 OR SQLCODE = -1408 THEN
            DBMS_OUTPUT.PUT_LINE('Index idx_equipment_dept already exists.');
        ELSE
            DBMS_OUTPUT.PUT_LINE('Error: ' || SQLERRM);
        END IF;
END;
/

BEGIN
    EXECUTE IMMEDIATE 'CREATE INDEX idx_equipment_status ON EQUIPMENT(STATUS)';
    DBMS_OUTPUT.PUT_LINE('Index idx_equipment_status created.');
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE = -955 OR SQLCODE = -1408 THEN
            DBMS_OUTPUT.PUT_LINE('Index idx_equipment_status already exists.');
        ELSE
            DBMS_OUTPUT.PUT_LINE('Error: ' || SQLERRM);
        END IF;
END;
/

-- Add other indexes similarly...

-- 4. Insert sample data (only if tables are empty)
DECLARE
    v_dept_count NUMBER;
    v_tech_count NUMBER;
    v_eq_count NUMBER;
BEGIN
    -- Check if DEPARTMENTS has data
    SELECT COUNT(*) INTO v_dept_count FROM DEPARTMENTS;
    
    IF v_dept_count = 0 THEN
        -- Insert Departments
        INSERT INTO DEPARTMENTS (DEPT_ID, DEPT_NAME, LOCATION, HEAD_OF_DEPT, CREATED_DATE) 
        VALUES (seq_dept_id.NEXTVAL, 'Computer Science', 'Building A, Floor 3', 'Dr. James Smith', SYSDATE);
        
        INSERT INTO DEPARTMENTS (DEPT_ID, DEPT_NAME, LOCATION, HEAD_OF_DEPT, CREATED_DATE) 
        VALUES (seq_dept_id.NEXTVAL, 'Engineering', 'Building B, Floor 2', 'Prof. Sarah Johnson', SYSDATE);
        
        INSERT INTO DEPARTMENTS (DEPT_ID, DEPT_NAME, LOCATION, HEAD_OF_DEPT, CREATED_DATE) 
        VALUES (seq_dept_id.NEXTVAL, 'Medical School', 'Building C, Floor 1', 'Dr. Michael Brown', SYSDATE);
        
        -- Insert 7 more departments
        FOR i IN 4..10 LOOP
            INSERT INTO DEPARTMENTS (DEPT_ID, DEPT_NAME, LOCATION, HEAD_OF_DEPT, CREATED_DATE) 
            VALUES (seq_dept_id.NEXTVAL, 
                   'Department ' || i, 
                   'Building ' || CHR(64+i) || ', Floor ' || MOD(i, 4)+1,
                   'Head ' || i,
                   SYSDATE);
        END LOOP;
        
        DBMS_OUTPUT.PUT_LINE('Inserted ' || (10) || ' departments.');
    ELSE
        DBMS_OUTPUT.PUT_LINE('Departments already has ' || v_dept_count || ' records.');
    END IF;
    
    -- Check if TECHNICIANS has data
    SELECT COUNT(*) INTO v_tech_count FROM TECHNICIANS;
    
    IF v_tech_count = 0 THEN
        -- Insert Technicians
        INSERT INTO TECHNICIANS (TECH_ID, FULL_NAME, CONTACT, SPECIALTY, EMAIL, HIRE_DATE, STATUS, HOURLY_RATE) 
        VALUES (seq_tech_id.NEXTVAL, 'John Doe', '0781234567', 'Electronics', 'john.doe@auca.ac.rw', DATE '2023-01-15', 'Active', 30.00);
        
        INSERT INTO TECHNICIANS (TECH_ID, FULL_NAME, CONTACT, SPECIALTY, EMAIL, HIRE_DATE, STATUS, HOURLY_RATE) 
        VALUES (seq_tech_id.NEXTVAL, 'Jane Smith', '0787654321', 'Computers', 'jane.smith@auca.ac.rw', DATE '2023-03-20', 'Active', 35.00);
        
        -- Insert 8 more technicians
        FOR i IN 3..10 LOOP
            INSERT INTO TECHNICIANS (TECH_ID, FULL_NAME, CONTACT, SPECIALTY, EMAIL, HIRE_DATE, STATUS, HOURLY_RATE) 
            VALUES (seq_tech_id.NEXTVAL, 
                   'Technician ' || i,
                   '078' || LPAD(1000000 + i*1000, 7, '0'),
                   CASE MOD(i, 4) 
                       WHEN 0 THEN 'Electronics' 
                       WHEN 1 THEN 'Computers' 
                       WHEN 2 THEN 'Mechanical' 
                       ELSE 'General' 
                   END,
                   'tech' || i || '@auca.ac.rw',
                   SYSDATE - (i*30),
                   'Active',
                   25.00 + MOD(i, 10));
        END LOOP;
        
        DBMS_OUTPUT.PUT_LINE('Inserted ' || (10) || ' technicians.');
    ELSE
        DBMS_OUTPUT.PUT_LINE('Technicians already has ' || v_tech_count || ' records.');
    END IF;
    
    -- Check if EQUIPMENT has data
    SELECT COUNT(*) INTO v_eq_count FROM EQUIPMENT;
    
    IF v_eq_count = 0 THEN
        -- Insert Equipment
        FOR i IN 1..100 LOOP
            INSERT INTO EQUIPMENT (
                EQUIPMENT_ID, NAME, CATEGORY, PURCHASE_DATE, WARRANTY_EXPIRY, 
                STATUS, DEPT_ID, SERIAL_NUMBER, MANUFACTURER, MODEL,
                TOTAL_MAINTENANCE_COST
            ) VALUES (
                seq_equipment_id.NEXTVAL,
                'Equipment ' || i,
                CASE MOD(i, 5) 
                    WHEN 0 THEN 'Medical' 
                    WHEN 1 THEN 'IT' 
                    WHEN 2 THEN 'Lab' 
                    WHEN 3 THEN 'Office' 
                    ELSE 'General' 
                END,
                SYSDATE - (365 * MOD(i, 5) + i*10),
                SYSDATE + (365 * 2),
                CASE MOD(i, 10)
                    WHEN 0 THEN 'Under Maintenance'
                    WHEN 1 THEN 'Inactive'
                    WHEN 2 THEN 'Retired'
                    ELSE 'Active'
                END,
                MOD(i, 10) + 1,
                'SN-' || LPAD(i, 6, '0'),
                CASE MOD(i, 3)
                    WHEN 0 THEN 'Dell'
                    WHEN 1 THEN 'HP'
                    ELSE 'IBM'
                END,
                'Model ' || CHR(65 + MOD(i, 3)),
                MOD(i, 1000) * 10.50
            );
        END LOOP;
        
        DBMS_OUTPUT.PUT_LINE('Inserted ' || (100) || ' equipment items.');
    ELSE
        DBMS_OUTPUT.PUT_LINE('Equipment already has ' || v_eq_count || ' records.');
    END IF;
    
    COMMIT;
    
EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Error inserting data: ' || SQLERRM);
        ROLLBACK;
END;
/

-- 5. Data validation queries
PROMPT ============================================
PROMPT DATA VALIDATION RESULTS
PROMPT ============================================

SELECT 'Departments: ' || COUNT(*) AS total_departments FROM DEPARTMENTS
UNION ALL
SELECT 'Equipment: ' || COUNT(*) AS total_equipment FROM EQUIPMENT
UNION ALL
SELECT 'Technicians: ' || COUNT(*) AS total_technicians FROM TECHNICIANS
UNION ALL
SELECT 'Maintenance: ' || COUNT(*) AS total_maintenance FROM MAINTENANCE
UNION ALL
SELECT 'Users: ' || COUNT(*) AS total_users FROM USERS
UNION ALL
SELECT 'Alerts: ' || COUNT(*) AS total_alerts FROM ALERTS
UNION ALL
SELECT 'Holidays: ' || COUNT(*) AS total_holidays FROM HOLIDAYS
UNION ALL
SELECT 'Audit Log: ' || COUNT(*) AS total_audit_log FROM AUDIT_LOG;

PROMPT 
PROMPT Sample Equipment Data (first 10 rows):
SELECT * FROM EQUIPMENT WHERE ROWNUM <= 10;

PROMPT 
PROMPT Sample Departments:
SELECT * FROM DEPARTMENTS;

PROMPT 
PROMPT Sample Technicians:
SELECT * FROM TECHNICIANS WHERE ROWNUM <= 5;

PROMPT 
PROMPT ============================================
PROMPT TABLE STRUCTURE VERIFICATION
PROMPT ============================================

SELECT table_name, num_rows, last_analyzed 
FROM user_tables 
ORDER BY table_name;

-- 6. Test queries for project submission
PROMPT 
PROMPT ============================================
PROMPT TEST QUERIES FOR PROJECT SUBMISSION
PROMPT ============================================

-- Test 1: Basic retrieval
PROMPT Test 1: All Active Equipment
SELECT EQUIPMENT_ID, NAME, CATEGORY, STATUS 
FROM EQUIPMENT 
WHERE STATUS = 'Active' AND ROWNUM <= 5;

-- Test 2: Joins
PROMPT 
PROMPT Test 2: Equipment with Department Info
SELECT e.NAME, e.CATEGORY, d.DEPT_NAME, d.LOCATION
FROM EQUIPMENT e
JOIN DEPARTMENTS d ON e.DEPT_ID = d.DEPT_ID
WHERE ROWNUM <= 5;

-- Test 3: Aggregations
PROMPT 
PROMPT Test 3: Maintenance Cost by Department
SELECT d.DEPT_NAME, 
       COUNT(e.EQUIPMENT_ID) AS equipment_count,
       SUM(e.TOTAL_MAINTENANCE_COST) AS total_cost,
       ROUND(AVG(e.TOTAL_MAINTENANCE_COST), 2) AS avg_cost
FROM DEPARTMENTS d
LEFT JOIN EQUIPMENT e ON d.DEPT_ID = e.DEPT_ID
GROUP BY d.DEPT_NAME
ORDER BY total_cost DESC NULLS LAST;

-- Test 4: Subqueries
PROMPT 
PROMPT Test 4: Equipment Needing Maintenance
SELECT NAME, CATEGORY, 
       (SELECT DEPT_NAME FROM DEPARTMENTS d WHERE d.DEPT_ID = e.DEPT_ID) AS department,
       TOTAL_MAINTENANCE_COST
FROM EQUIPMENT e
WHERE TOTAL_MAINTENANCE_COST > 1000
   OR STATUS = 'Under Maintenance'
ORDER BY TOTAL_MAINTENANCE_COST DESC;

-- Test 5: Data integrity check
PROMPT 
PROMPT Test 5: Data Integrity Verification
SELECT 'All tables created successfully' AS status FROM dual
UNION ALL
SELECT 'All sequences created successfully' AS status FROM dual
UNION ALL
SELECT 'Sample data inserted successfully' AS status FROM dual;

COMMIT;


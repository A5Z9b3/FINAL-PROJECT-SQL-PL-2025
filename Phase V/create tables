-- ============================================
-- PHASE V: TABLE IMPLEMENTATION & DATA INSERTION
-- ============================================

-- 1. CREATE TABLES WITH CONSTRAINTS
CREATE TABLE departments (
    dept_id NUMBER(10) PRIMARY KEY,
    dept_name VARCHAR2(100) NOT NULL,
    manager_id NUMBER(10),
    location VARCHAR2(100),
    created_date DATE DEFAULT SYSDATE
);

CREATE TABLE employees (
    emp_id NUMBER(10) PRIMARY KEY,
    first_name VARCHAR2(50) NOT NULL,
    last_name VARCHAR2(50) NOT NULL,
    email VARCHAR2(100) UNIQUE NOT NULL,
    phone VARCHAR2(20),
    hire_date DATE NOT NULL,
    job_title VARCHAR2(100),
    salary NUMBER(10,2),
    dept_id NUMBER(10),
    status VARCHAR2(20) DEFAULT 'ACTIVE',
    CONSTRAINT fk_emp_dept FOREIGN KEY (dept_id) REFERENCES departments(dept_id),
    CONSTRAINT chk_salary CHECK (salary > 0),
    CONSTRAINT chk_status CHECK (status IN ('ACTIVE', 'INACTIVE', 'ON_LEAVE'))
);

CREATE TABLE equipment (
    equipment_id NUMBER(10) PRIMARY KEY,
    equipment_name VARCHAR2(100) NOT NULL,
    serial_number VARCHAR2(50) UNIQUE,
    category VARCHAR2(50),
    purchase_date DATE,
    purchase_cost NUMBER(10,2),
    status VARCHAR2(20) DEFAULT 'OPERATIONAL',
    location VARCHAR2(100),
    assigned_to NUMBER(10),
    last_maintenance DATE,
    next_maintenance DATE,
    CONSTRAINT fk_eq_assigned FOREIGN KEY (assigned_to) REFERENCES employees(emp_id),
    CONSTRAINT chk_eq_status CHECK (status IN ('OPERATIONAL', 'UNDER_MAINTENANCE', 'DECOMMISSIONED', 'LOST'))
);

CREATE TABLE maintenance (
    maintenance_id NUMBER(10) PRIMARY KEY,
    equipment_id NUMBER(10) NOT NULL,
    maintenance_date DATE NOT NULL,
    maintenance_type VARCHAR2(50),
    technician_id NUMBER(10),
    description VARCHAR2(500),
    cost NUMBER(10,2),
    status VARCHAR2(20) DEFAULT 'COMPLETED',
    next_maintenance DATE,
    CONSTRAINT fk_maint_eq FOREIGN KEY (equipment_id) REFERENCES equipment(equipment_id),
    CONSTRAINT fk_maint_tech FOREIGN KEY (technician_id) REFERENCES employees(emp_id)
);

CREATE TABLE work_orders (
    order_id NUMBER(10) PRIMARY KEY,
    equipment_id NUMBER(10),
    assigned_to NUMBER(10),
    priority VARCHAR2(20) DEFAULT 'MEDIUM',
    description VARCHAR2(500),
    created_date DATE DEFAULT SYSDATE,
    due_date DATE,
    completed_date DATE,
    status VARCHAR2(20) DEFAULT 'OPEN',
    CONSTRAINT fk_wo_eq FOREIGN KEY (equipment_id) REFERENCES equipment(equipment_id),
    CONSTRAINT fk_wo_emp FOREIGN KEY (assigned_to) REFERENCES employees(emp_id),
    CONSTRAINT chk_priority CHECK (priority IN ('LOW', 'MEDIUM', 'HIGH', 'CRITICAL')),
    CONSTRAINT chk_wo_status CHECK (status IN ('OPEN', 'IN_PROGRESS', 'COMPLETED', 'CANCELLED'))
);

-- 2. CREATE INDEXES FOR PERFORMANCE
CREATE INDEX idx_emp_dept ON employees(dept_id);
CREATE INDEX idx_emp_status ON employees(status);
CREATE INDEX idx_eq_status ON equipment(status);
CREATE INDEX idx_eq_assigned ON equipment(assigned_to);
CREATE INDEX idx_maint_eq ON maintenance(equipment_id);
CREATE INDEX idx_maint_date ON maintenance(maintenance_date);
CREATE INDEX idx_wo_status ON work_orders(status);
CREATE INDEX idx_wo_due ON work_orders(due_date);

-- 3. CREATE SEQUENCES
CREATE SEQUENCE seq_dept_id START WITH 100 INCREMENT BY 1;
CREATE SEQUENCE seq_emp_id START WITH 1000 INCREMENT BY 1;
CREATE SEQUENCE seq_eq_id START WITH 5000 INCREMENT BY 1;
CREATE SEQUENCE seq_maint_id START WITH 10000 INCREMENT BY 1;
CREATE SEQUENCE seq_wo_id START WITH 20000 INCREMENT BY 1;

-- 4. INSERT REALISTIC DATA (100+ rows per main table)
-- Departments
INSERT INTO departments (dept_id, dept_name, manager_id, location) VALUES
(seq_dept_id.NEXTVAL, 'Information Technology', 1001, 'Building A, Floor 3');
INSERT INTO departments (dept_id, dept_name, manager_id, location) VALUES
(seq_dept_id.NEXTVAL, 'Human Resources', 1002, 'Building B, Floor 2');
INSERT INTO departments (dept_id, dept_name, manager_id, location) VALUES
(seq_dept_id.NEXTVAL, 'Finance', 1003, 'Building C, Floor 4');
INSERT INTO departments (dept_id, dept_name, manager_id, location) VALUES
(seq_dept_id.NEXTVAL, 'Operations', 1004, 'Building D, Floor 1');
INSERT INTO departments (dept_id, dept_name, manager_id, location) VALUES
(seq_dept_id.NEXTVAL, 'Maintenance', 1005, 'Building E, Floor 2');

-- Employees (50+ rows)
BEGIN
    FOR i IN 1..50 LOOP
        INSERT INTO employees (emp_id, first_name, last_name, email, phone, hire_date, job_title, salary, dept_id) VALUES
        (seq_emp_id.NEXTVAL,
         CASE MOD(i,5) WHEN 0 THEN 'James' WHEN 1 THEN 'Mary' WHEN 2 THEN 'John' WHEN 3 THEN 'Patricia' ELSE 'Robert' END,
         CASE MOD(i,7) WHEN 0 THEN 'Smith' WHEN 1 THEN 'Johnson' WHEN 2 THEN 'Williams' WHEN 3 THEN 'Brown' WHEN 4 THEN 'Jones' WHEN 5 THEN 'Garcia' ELSE 'Miller' END,
         'emp' || (1000+i) || '@company.com',
         '+25078' || LPAD(MOD(i*123, 1000000), 6, '0'),
         SYSDATE - (365 * (2 + MOD(i,5))),
         CASE WHEN i <= 5 THEN 'Manager' 
              WHEN i <= 15 THEN 'Senior Engineer'
              WHEN i <= 30 THEN 'Engineer'
              WHEN i <= 40 THEN 'Technician'
              ELSE 'Associate' END,
         CASE WHEN i <= 5 THEN 80000 + (i*5000)
              WHEN i <= 15 THEN 60000 + (i*3000)
              WHEN i <= 30 THEN 45000 + (i*2000)
              ELSE 30000 + (i*1000) END,
         CASE MOD(i,5) WHEN 0 THEN 100 WHEN 1 THEN 101 WHEN 2 THEN 102 WHEN 3 THEN 103 ELSE 104 END);
    END LOOP;
    COMMIT;
END;
/

-- Equipment (100+ rows)
BEGIN
    FOR i IN 1..100 LOOP
        INSERT INTO equipment (equipment_id, equipment_name, serial_number, category, purchase_date, purchase_cost, status, location, assigned_to) VALUES
        (seq_eq_id.NEXTVAL,
         CASE MOD(i,10) 
            WHEN 0 THEN 'Laptop Dell XPS'
            WHEN 1 THEN 'Desktop HP Elite'
            WHEN 2 THEN 'Server Rack'
            WHEN 3 THEN 'Network Switch'
            WHEN 4 THEN 'Projector Epson'
            WHEN 5 THEN 'Printer Canon'
            WHEN 6 THEN 'Scanner Fujitsu'
            WHEN 7 THEN 'Tablet iPad'
            WHEN 8 THEN 'Monitor Samsung'
            ELSE 'Phone System' END || ' ' || i,
         'SN' || LPAD(i, 8, '0'),
         CASE MOD(i,4) WHEN 0 THEN 'COMPUTER' WHEN 1 THEN 'NETWORK' WHEN 2 THEN 'OFFICE' ELSE 'COMMUNICATION' END,
         SYSDATE - (365 * MOD(i,3)),
         CASE MOD(i,4) WHEN 0 THEN 1200 WHEN 1 THEN 800 WHEN 2 THEN 500 ELSE 1500 END,
         CASE MOD(i,20) WHEN 0 THEN 'UNDER_MAINTENANCE' WHEN 19 THEN 'DECOMMISSIONED' ELSE 'OPERATIONAL' END,
         CASE MOD(i,3) WHEN 0 THEN 'Room 101' WHEN 1 THEN 'Room 205' ELSE 'Room 310' END,
         CASE WHEN MOD(i,3) = 0 THEN 1000 + MOD(i,20) ELSE NULL END);
    END LOOP;
    COMMIT;
END;
/

-- Maintenance Records (200+ rows)
BEGIN
    FOR i IN 1..200 LOOP
        INSERT INTO maintenance (maintenance_id, equipment_id, maintenance_date, maintenance_type, technician_id, description, cost, status) VALUES
        (seq_maint_id.NEXTVAL,
         5000 + MOD(i, 100),
         SYSDATE - MOD(i, 180),
         CASE MOD(i,5) WHEN 0 THEN 'PREVENTIVE' WHEN 1 THEN 'CORRECTIVE' WHEN 2 THEN 'UPGRADE' WHEN 3 THEN 'CALIBRATION' ELSE 'INSPECTION' END,
         1000 + MOD(i, 20),
         CASE MOD(i,5) 
            WHEN 0 THEN 'Regular scheduled maintenance'
            WHEN 1 THEN 'Repair of faulty component'
            WHEN 2 THEN 'Software upgrade installed'
            WHEN 3 THEN 'Calibration and testing'
            ELSE 'Routine inspection' END,
         CASE MOD(i,5) WHEN 0 THEN 200 WHEN 1 THEN 450 WHEN 2 THEN 300 WHEN 3 THEN 150 ELSE 100 END,
         CASE MOD(i,20) WHEN 0 THEN 'SCHEDULED' WHEN 19 THEN 'CANCELLED' ELSE 'COMPLETED' END);
    END LOOP;
    COMMIT;
END;
/

-- Work Orders (150+ rows)
BEGIN
    FOR i IN 1..150 LOOP
        INSERT INTO work_orders (order_id, equipment_id, assigned_to, priority, description, created_date, due_date, status) VALUES
        (seq_wo_id.NEXTVAL,
         5000 + MOD(i, 100),
         1000 + MOD(i, 20),
         CASE MOD(i,20) 
            WHEN 0 THEN 'CRITICAL'
            WHEN 1 THEN 'HIGH'
            WHEN 19 THEN 'LOW'
            ELSE 'MEDIUM' END,
         'Work order for ' || CASE MOD(i,5) WHEN 0 THEN 'repair' WHEN 1 THEN 'maintenance' WHEN 2 THEN 'inspection' WHEN 3 THEN 'upgrade' ELSE 'installation' END,
         SYSDATE - MOD(i, 60),
         SYSDATE + MOD(i, 30),
         CASE MOD(i,10) 
            WHEN 0 THEN 'OPEN'
            WHEN 1 THEN 'IN_PROGRESS'
            WHEN 9 THEN 'CANCELLED'
            ELSE 'COMPLETED' END);
    END LOOP;
    COMMIT;
END;
/

-- 5. DATA INTEGRITY VERIFICATION QUERIES
-- Verify table counts
SELECT 'Departments' AS table_name, COUNT(*) AS row_count FROM departments
UNION ALL
SELECT 'Employees', COUNT(*) FROM employees
UNION ALL
SELECT 'Equipment', COUNT(*) FROM equipment
UNION ALL
SELECT 'Maintenance', COUNT(*) FROM maintenance
UNION ALL
SELECT 'Work Orders', COUNT(*) FROM work_orders;

-- Verify foreign key relationships
SELECT e.equipment_id, e.equipment_name, m.maintenance_count
FROM equipment e
LEFT JOIN (
    SELECT equipment_id, COUNT(*) as maintenance_count
    FROM maintenance
    GROUP BY equipment_id
) m ON e.equipment_id = m.equipment_id
WHERE ROWNUM <= 10;

-- Test constraints
SELECT 'Active Employees' AS check_type, COUNT(*) AS count FROM employees WHERE status = 'ACTIVE'
UNION ALL
SELECT 'Operational Equipment', COUNT(*) FROM equipment WHERE status = 'OPERATIONAL'
UNION ALL
SELECT 'High Priority Orders', COUNT(*) FROM work_orders WHERE priority = 'HIGH'
UNION ALL
SELECT 'Overdue Orders', COUNT(*) FROM work_orders WHERE due_date < SYSDATE AND status NOT IN ('COMPLETED', 'CANCELLED');

-- Aggregation example
SELECT d.dept_name, 
       COUNT(e.emp_id) AS employee_count,
       AVG(e.salary) AS avg_salary,
       SUM(eq.purchase_cost) AS total_equipment_cost
FROM departments d
LEFT JOIN employees e ON d.dept_id = e.dept_id
LEFT JOIN equipment eq ON e.emp_id = eq.assigned_to
GROUP BY d.dept_name
ORDER BY employee_count DESC;

-- Subquery example
SELECT eq.equipment_name, eq.status,
       (SELECT COUNT(*) FROM maintenance m WHERE m.equipment_id = eq.equipment_id) AS maintenance_count,
       (SELECT MAX(maintenance_date) FROM maintenance m WHERE m.equipment_id = eq.equipment_id) AS last_maintenance
FROM equipment eq
WHERE ROWNUM <= 15;
